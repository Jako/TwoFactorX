/*!
 * TwoFactorX - Two-factor authentication for MODX
 * Version: 1.1.1
 * Build date: 2025-07-09
 */
var twofactorx=function(t){twofactorx.superclass.constructor.call(this,t=t||{})},TwoFactorX=(Ext.extend(twofactorx,Ext.Component,{initComponent:function(){this.stores={},this.ajax=new Ext.data.Connection({disableCaching:!0})},page:{},window:{},grid:{},tree:{},panel:{},combo:{},config:{},util:{},form:{}}),Ext.reg("twofactorx",twofactorx),new twofactorx);TwoFactorX.util={urlTpl:new Ext.XTemplate('<tpl for=".">{connector_url}?action={action}&accountname={accountname}&secret={secret}&issuer={issuer}&HTTP_MODAUTH={site_id}</tpl>',{compiled:!0}),getUserSettings:function(){MODx.Ajax.request({url:TwoFactorX.config.connectorUrl,params:{action:"mgr/user/getsettings",id:MODx.request.id,admin:MODx.user.id},listeners:{success:{fn:function(t){var e=Ext.getCmp("twofactorx-btn-changestatus"),o=Ext.getCmp("twofactorx-status"),c=Ext.getCmp("twofactorx-secret"),r=Ext.getCmp("twofactorx-uri");document.getElementById("twofactorx-qrcode");c.setValue(t.object.secret),r.setValue(decodeURIComponent(t.object.uri)),document.getElementById("twofactorx-qrcode").src=TwoFactorX.util.urlTpl.apply({connector_url:TwoFactorX.config.connectorUrl,action:"mgr/qrcode/get",accountname:t.object.accountname,secret:t.object.secret,issuer:t.object.issuer,site_id:MODx.siteId}),!0===t.object.totp_disabled&&(e.setText(_("twofactorx.enable")),o.setValue(_("twofactorx.disabled")),o.addClass("red")),!1===t.object.totp_disabled&&(e.setText(_("twofactorx.disable")),o.setValue(_("twofactorx.enabled")),o.removeClass("red"))},scope:this}}})},getUserQRCode:function(o="twofactorx-secret",c="twofactorx-qrcode"){MODx.Ajax.request({url:TwoFactorX.config.connectorUrl,params:{action:"mgr/user/getqrcode"},listeners:{success:{fn:function(t){var e=Ext.getCmp(o);e&&e.setValue(t.object.secret),document.getElementById(c).src=TwoFactorX.util.urlTpl.apply({connector_url:TwoFactorX.config.connectorUrl,action:"mgr/qrcode/get",accountname:t.object.accountname,secret:t.object.secret,issuer:t.object.issuer,site_id:MODx.siteId})},scope:this}}})},changeStatus:function(t){var e,o;"yes"===t?(e=" - ",(o=Ext.getCmp("twofactorx-status")).getValue()===_("twofactorx.enabled")?e="ENABLED":o.getValue()===_("twofactorx.disabled")&&(e="DISABLED"),MODx.Ajax.request({url:TwoFactorX.config.connectorUrl,params:{action:"mgr/status/change",id:MODx.request.id,admin:MODx.user.id,status:e},listeners:{success:{fn:TwoFactorX.util.getUserSettings}}})):"no"!==t&&TwoFactorX.util.confirm(_("twofactorx.changestatus_confirm"),TwoFactorX.util.changeStatus)},resetSecret:function(t){"yes"===t?MODx.Ajax.request({url:TwoFactorX.config.connectorUrl,params:{action:"mgr/secret/reset",id:MODx.request.id,admin:MODx.user.id},listeners:{success:{fn:TwoFactorX.util.getUserSettings}}}):"no"!==t&&TwoFactorX.util.confirm(_("twofactorx.resetsecret_confirm"),TwoFactorX.util.resetSecret)},emailInstructions:function(t){"yes"===t?MODx.Ajax.request({url:TwoFactorX.config.connectorUrl,params:{action:"mgr/email/instructions",id:MODx.request.id,admin:MODx.user.id},listeners:{success:{fn:function(t){TwoFactorX.util.alert(t.message)}}}}):"no"!==t&&TwoFactorX.util.confirm(_("twofactorx.emailinstructions_confirm"),TwoFactorX.util.emailInstructions)},emailQR:function(t){"yes"===t?MODx.Ajax.request({url:TwoFactorX.config.connectorUrl,params:{action:"mgr/email/secret",id:MODx.request.id,admin:MODx.user.id},listeners:{success:{fn:function(t){TwoFactorX.util.alert(t.message)}}}}):"no"!==t&&TwoFactorX.util.confirm(_("twofactorx.emailqr_confirm"),TwoFactorX.util.emailQR)},confirm:function(t,e){Ext.MessageBox.show({title:_("twofactorx"),msg:t,width:500,buttons:Ext.MessageBox.YESNO,fn:e,icon:Ext.MessageBox.QUESTION})},alert:function(t){Ext.MessageBox.show({title:_("twofactorx"),msg:t,width:400,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO})}};